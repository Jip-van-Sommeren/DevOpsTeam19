name: Deploy to Lambda

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.13

      # Install shared dependencies for functions (if any)
      - name: Install function dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt -t python/lib/python3.13/site-packages
          fi

      ##############################
      # Build & Publish the Layer  #
      ##############################
      - name: Package Layer
        run: |
          # Ensure the layer package has a "python" folder at its root
          zip -r db_layer.zip python
      - name: Publish Lambda Layer (if changed)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          chmod +x scripts/check_and_publish_layer.sh
          ./scripts/check_and_publish_layer.sh

      #########################################
      # Package & Deploy items_method Lambda  #
      #########################################
      - name: Package items_method function
        run: |
          cd src
          zip -r items_method.zip items_method.py
          cd ..
      - name: Deploy items_method Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name items_method \
            --zip-file fileb://src/items_method.zip
          check_update items_method
      - name: Update items_method Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name items_method \
            --handler items_method.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update items_method

      ###################################################
      # Package & Deploy items_item_id_methods Lambda   #
      ###################################################
      - name: Package items_item_id_methods function
        run: |
          cd src
          zip -r items_item_id_methods.zip items_item_id_methods.py
          cd ..
      - name: Deploy items_item_id_methods Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name items_item_id_methods \
            --zip-file fileb://src/items_item_id_methods.zip
          check_update items_item_id_methods
      - name: Update items_item_id_methods Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name items_item_id_methods \
            --handler items_item_id_methods.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update items_item_id_methods
      ###################################################
      # Package & Deploy purchases_purchase_id_method Lambda   #
      ###################################################
      - name: Package purchases_purchase_id_method function
        run: |
          cd src
          zip -r purchases_purchase_id_method.zip purchases_purchase_id_method.py
          cd ..
      - name: Deploy purchases_purchase_id_method Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name purchases_purchase_id_method \
            --zip-file fileb://src/purchases_purchase_id_method.zip
          check_update purchases_purchase_id_method
      - name: Update purchases_purchase_id_method Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name purchases_purchase_id_method \
            --handler purchases_purchase_id_method.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update purchases_purchase_id_method

      ###################################################
      # Package & Deploy purchases_methods Lambda   #
      ###################################################
      - name: Package purchases_methods function
        run: |
          cd src
          zip -r purchases_methods.zip purchases_methods.py
          cd ..
      - name: Deploy purchases_methods Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name purchases_methods \
            --zip-file fileb://src/purchases_methods.zip
          check_update purchases_methods
      - name: Update purchases_methods Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh

          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name purchases_methods \
            --handler purchases_methods.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update purchases_methods

      ###################################################
      # Package & Deploy location_methods Lambda   #
      ###################################################
      - name: Package location_methods function
        run: |
          cd src
          zip -r location_methods.zip location_methods.py
          cd ..
      - name: Deploy location_methods Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name location_methods \
            --zip-file fileb://src/location_methods.zip
          check_update location_methods
      - name: Update location_methods Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name location_methods \
            --handler location_methods.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update location_methods

      ###################################################
      # Package & Deploy location_location_id_method Lambda   #
      ###################################################
      - name: Package location_location_id_method function
        run: |
          cd src
          zip -r location_location_id_method.zip location_location_id_method.py
          cd ..
      - name: Deploy location_location_id_method Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name location_location_id_method \
            --zip-file fileb://src/location_location_id_method.zip
          check_update location_location_id_method
      - name: Update location_location_id_method Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name location_location_id_method \
            --handler location_location_id_method.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update location_location_id_method

      ###################################################
      # Package & Deploy reservations_reservation_id_method Lambda   #
      ###################################################
      - name: Package reservations_reservation_id_method function
        run: |
          cd src
          zip -r reservations_reservation_id_method.zip reservations_reservation_id_method.py
          cd ..
      - name: Deploy reservations_reservation_id_method Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name reservations_reservation_id_method \
            --zip-file fileb://src/reservations_reservation_id_method.zip
          check_update reservations_reservation_id_method
      - name: Update reservations_reservation_id_method Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name reservations_reservation_id_method \
            --handler reservations_reservation_id_method.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update reservations_reservation_id_method

      ###################################################
      # Package & Deploy reservations_methods Lambda   #
      ###################################################
      - name: Package reservations_methods function
        run: |
          cd src
          zip -r reservations_methods.zip reservations_methods.py
          cd ..
      - name: Deploy reservations_methods Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name reservations_methods \
            --zip-file fileb://src/reservations_methods.zip
          check_update reservations_methods
      - name: Update reservations_methods Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name reservations_methods \
            --handler reservations_methods.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update reservations_methods

      ###################################################
      # Package & Deploy stock_methods Lambda   #
      ###################################################
      - name: Package stock_methods function
        run: |
          cd src
          zip -r stock_methods.zip stock_methods.py
          cd ..
      - name: Deploy stock_methods Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name stock_methods \
            --zip-file fileb://src/stock_methods.zip
          check_update stock_methods
      - name: Update stock_methods Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name stock_methods \
            --handler stock_methods.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update stock_methods

      ###################################################
      # Package & Deploy invokeReservationStep Lambda   #
      ###################################################
      - name: Package invokeReservationStep function
        run: |
          cd src
          zip -r invokeReservationStep.zip invoke_reservation_step.py
          cd ..
      - name: Deploy invokeReservationStep Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name invokeReservationStep \
            --zip-file fileb://src/invokeReservationStep.zip
          check_update invokeReservationStep
      - name: Update invokeReservationStep Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name invokeReservationStep \
            --handler invokeReservationStep.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update invokeReservationStep

      ###################################################
      # Package & Deploy invokePurchaseStep Lambda   #
      ###################################################
      - name: Package invokePurchaseStep function
        run: |
          cd src
          zip -r invokePurchaseStep.zip invoke_purchase_step.py
          cd ..
      - name: Deploy invokePurchaseStep Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name invokePurchaseStep \
            --zip-file fileb://src/invokePurchaseStep.zip
          check_update invokePurchaseStep
      - name: Update invokePurchaseStep Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name invokePurchaseStep \
            --handler invokePurchaseStep.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update invokePurchaseStep

      ###################################################
      # Package & Deploy purchase_post Lambda   #
      ###################################################
      - name: Package purchase_post function
        run: |
          cd src
          zip -r purchase_post.zip purchase_item.py
          cd ..
      - name: Deploy purchase_post Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name purchase_post \
            --zip-file fileb://src/purchase_post.zip
          check_update purchase_post
      - name: Update purchase_post Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name purchase_post \
            --handler purchase_post.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update purchase_post

      ###################################################
      # Package & Deploy reservation_post Lambda   #
      ###################################################
      - name: Package reservation_post function
        run: |
          cd src
          zip -r reservation_post.zip reservation_item.py
          cd ..
      - name: Deploy reservation_post Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name reservation_post \
            --zip-file fileb://src/reservation_post.zip
          check_update reservation_post
      - name: Update reservation_post Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name reservation_post \
            --handler reservation_post.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update reservation_post

      ###################################################
      # Package & Deploy updateStockLambda Lambda   #
      ###################################################
      - name: Package updateStockLambda function
        run: |
          cd src
          zip -r updateStockLambda.zip update_stock.py
          cd ..
      - name: Deploy updateStockLambda Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name updateStockLambda \
            --zip-file fileb://src/updateStockLambda.zip
          check_update updateStockLambda
      - name: Update updateStockLambda Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name updateStockLambda \
            --handler updateStockLambda.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update updateStockLambda

      ###################################################
      # Package & Deploy purchaseError Lambda   #
      ###################################################
      - name: Package purchaseError function
        run: |
          cd src
          zip -r purchaseError.zip purchase_error.py
          cd ..
      - name: Deploy purchaseError Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name purchaseError \
            --zip-file fileb://src/purchaseError.zip
          check_update purchaseError
      - name: Update purchaseError Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name purchaseError \
            --handler purchaseError.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update purchaseError

      ###################################################
      # Package & Deploy deleteReservation Lambda   #
      ###################################################
      - name: Package deleteReservation function
        run: |
          cd src
          zip -r deleteReservation.zip reservation_error.py
          cd ..
      - name: Deploy deleteReservation Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name deleteReservation \
            --zip-file fileb://src/deleteReservation.zip
          check_update deleteReservation
      - name: Update deleteReservation Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name deleteReservation \
            --handler deleteReservation.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update deleteReservation

      ###################################################
      # Package & Deploy reservation_reservation_id_put Lambda   #
      ###################################################
      - name: Package reservation_reservation_id_put function
        run: |
          cd src
          zip -r reservation_reservation_id_put.zip reservation_reservation_id_put.py
          cd ..
      - name: Deploy reservation_reservation_id_put Lambda Function
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          aws lambda update-function-code \
            --function-name reservation_reservation_id_put \
            --zip-file fileb://src/reservation_reservation_id_put.zip
          check_update reservation_reservation_id_put
      - name: Update reservation_reservation_id_put Function Configuration (set handler)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          source scripts/check_update.sh
          LATEST_LAYER=$(aws lambda list-layer-versions --layer-name db_layer --query 'LayerVersions[0].LayerVersionArn' --output text)
          echo "Using latest layer ARN: $LATEST_LAYER"
          aws lambda update-function-configuration \
            --function-name reservation_reservation_id_put \
            --handler reservation_reservation_id_put.lambda_handler \
            --layers "$LATEST_LAYER"
          check_update reservation_reservation_id_put
